<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>マリガン基準ヘルパー</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
<script>
var id = 0;
function fileDragOver(e) {
	e.preventDefault()
}
function fileDrop(e) {
	e.preventDefault()
	const files = e.dataTransfer.files
	for (var i = 0; i < files.length; i++) {
		const file = files[i]

		const reader = new FileReader()
		reader.onload = (event) => {
			const base64Text = event.currentTarget.result

			const isExistsImage = [...document.querySelectorAll('.drag-list img')].map(elm => elm.src).includes(base64Text);
			if ( isExistsImage ) { return; }

			id++;
			document.querySelector('#uploadImageArea').innerHTML += `<li id="item${id}" data-original-file="${file.name}" draggable="true" class="unsorted-item"><span>0%</span><img src="${base64Text}" /></li>`

			// 順序入れ替え
			refreshRate();

			document.querySelectorAll('.drag-list li').forEach (elm => {
				// 選択中アイテムに色を付ける
				elm.onclick = function (event) {
					event.stopPropagation();
					event.currentTarget.classList.toggle("selected-item");
					releaseSelect(event.currentTarget);
				};
				// ドラッグ＆ドロップ動作
				elm.ondragstart = function (event) {
					event.dataTransfer.setData('text/plain', event.currentTarget.id);
					event.currentTarget.classList.add("selected-item");
					releaseSelect(event.currentTarget);
				};
				elm.ondragover = function (event) {
					event.preventDefault();
					this.classList.add("drop-target-border");
				};
				elm.ondragleave = function () {
					this.classList.remove("drop-target-border");
				};
				elm.ondrop = function (event) {
					event.preventDefault();
					let id = event.dataTransfer.getData('text/plain');
					let elm_drag = document.getElementById(id);
					elm_drag.classList.remove("unsorted-item");
					this.parentNode.insertBefore(elm_drag, this);
					this.classList.remove("drop-target-border");
					refreshRate();
				};
			});

		}
		reader.readAsDataURL(file)
	}
}
function onBodyClick() {
	releaseSelect(null);
}
function refreshRate() {
	var list = [...document.querySelectorAll('.drag-list li span')];
	list.forEach(elm => elm.innerText = String(Math.round((list.indexOf(elm) / list.length) * 100)).padStart(2, "0") + "%");
}
function releaseSelect(withoutElement) {
	[...document.querySelectorAll('.drag-list li')].filter(elm => elm != withoutElement).forEach(elm => {
		elm.classList.remove("selected-item");
	});
}

// 名称変更スクリプトを表示
function makeRenameCommand() {
	const getFileExt = f => f.split('.').pop();

	let command = "";

	const list = [...document.querySelectorAll('.drag-list li')];
	command += list.map(elm => `ren "${elm.dataset.originalFile}" "${"TMP_" + String(list.indexOf(elm)).padStart(4, "0") + "." + getFileExt(elm.dataset.originalFile)}"`).join("\n");

	command += "\n";
	command += "ren TMP_*.* IMG_*.*\n";

	document.querySelector("#txtOutputCommand").value = command;
	document.querySelector('#favDialog').showModal();
}
</script>
<style>
.drag-list {
	column-count		: 3;
	padding-left		: 0px;
	margin-left 		: 20px;
	margin-right		: 20px;
}
.drag-list li {
	list-style-type 	: none;
	margin-bottom 		: 5px;
}
.drag-list li img {
	width 				: calc(100% - 3em);
}
.unsorted-item {
	background-color	: cyan;
}
.selected-item {
	outline				: 5px solid orange;
}
.drop-target-border {
	border-top			: 10px solid red;
}
</style>
</head>
<body onclick="onBodyClick();">

<nav class="navbar navbar-dark bg-dark mb-3">
		<a class="navbar-brand ms-3" href="#">マリガン基準ヘルパー</a>
</nav>

<div class="container mb-3">
	<button type="button" class="btn btn-primary" onclick="makeRenameCommand()">現在の並び順を出力</button>
</div>
<ul id="uploadImageArea" class="drag-list"></ul>
<div class="container">
	<div ondrop="fileDrop(event)" ondragover="fileDragOver(event)" class="mb-3 d-flex justify-content-center border rounded">
		<div class="p-5">
			ここにドラッグ＆ドロップ
		</div>
	</div>
</div>

<dialog id="favDialog" style="width:80%; height:80vh;">
	<form method="dialog" style="height:100%; display:flex; flex-direction: column;">
		<div>現在の並び順になるよう、ファイル名を連番ファイルに変更するバッチファイルコマンドです。</div>
		<textarea id="txtOutputCommand" style="width:100%; margin-top:1em; margin-bottom:1em; flex:1;"></textarea>
		<button class="btn btn-secondary">閉じる</button>
	</form>
</dialog>

■todo
*N字で出せるようにする
*挿入位置の色を目立つように
*同じ画像は読み込まない
*選択中アイテムに色をつける
*		クリックでトグル。ONならそれ以外をOFF。
*		ドラッグ開始で開始要素をON、それ以外をOFF。
*スクリプト出力

■デザイン
・ソート
これは何？
使い方。ソート説明も書く

[大小アイコンも]
[未ソート色を全クリア]　[画像を全て削除]　[現在の並び順を出力]　※現在の並び順になるよう、ファイル名変更をするためのバッチコマンドを出力する。

N字

ここにドラッグ＆ドロップ

・名称変更スクリプトを書き出す。
		ファイル名をデータとしてもっとく
		書き出しボタンで、
		ファイル名→temp_連番→temp外し
		のバッチを書き出す

・オプション

・マリガンによる確率
どういう基準でマリガンすれば、手札の期待値を高くできるかの算出シミュレータ。
0回マリガン後の手札点数MAX：100　1回マリガン後の手札点数MAX：[80]　2回マリガン後の手札点数MAX：[60]　[計算]
														2回目キープ基準点
１回目キープ基準点

・先行後攻シミュレーター
対戦で後攻を連続して引いてしまうことは不自然ではないことを納得するためのツール。
対戦回数：[20]
先(青)　後(赤)


【参考URL】
https://codelikes.com/javascript-ondrop-ondragover/<br>
https://blog.ver001.com/javascript-dragdrop-sort/<br>
【以下はキープ】
クリーチャー2
クマノ、クリーチャー
クマノ、スクイーは除去があるならok


</body>
</html>
